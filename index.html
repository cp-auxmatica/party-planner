<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .grid-with-min { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        @media (min-width: 1024px) {
            .lg-main-content { grid-template-columns: minmax(300px, 1fr) 3fr; }
        }
        /* Hide scrollbar for a cleaner look */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modal backdrop for blur effect */
        .modal-backdrop { backdrop-filter: blur(8px); }
        .modal-bg.show .modal-card { transform: scale(1); opacity: 1; }
        .modal-card { transform: scale(0.95); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }

    </style>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs };
    </script>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Main Application Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 lg:mb-10">
            <div class="flex items-center gap-2 mb-4 sm:mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-party-popper text-amber-500">
                    <path d="M5.8 11.3 2 22l10.7-3.88c.84-.3 1.5-.96 1.8-1.8L22 2 11.3 5.8c-.84.3-1.5.96-1.8 1.8L2 22z"/>
                    <path d="M12 12l4 4"/>
                    <path d="M14 2c-2.7 0-5 2.2-5 5-2.7 0-5 2.2-5 5 2.7 0 5 2.2 5 5 2.7 0 5-2.2 5-5 2.7 0-5-2.2-5-5z"/>
                </svg>
                <h1 class="text-3xl font-bold tracking-tight">Party Planner</h1>
            </div>
            <div class="flex flex-wrap gap-2 sm:gap-4 w-full sm:w-auto">
                <button id="btnPlan" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M5 12h14"/><path d="M12 5v14"/>
                    </svg>
                    Plan a Party
                </button>
                <button id="btnAttend" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-plus">
                        <path d="M21 12V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                        <line x1="16" x2="16" y1="19" y2="19"/>
                        <line x1="18" x2="22" y1="19" y2="19"/>
                        <line x1="19" x2="19" y1="16" y2="22"/>
                    </svg>
                    Attend a Party
                </button>
            </div>
        </header>

        <!-- Sidebar and Main Content -->
        <main class="grid lg:grid-cols-[minmax(300px,1fr)_3fr] gap-6">
            <!-- Sidebar / Controls -->
            <div class="space-y-6">
                <!-- My Parties -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">My Parties</h2>
                        <span id="partyCount" class="text-xs font-medium bg-slate-100 text-slate-500 rounded-full px-2 py-0.5">0 Parties</span>
                    </div>
                    <div id="partyList" class="space-y-3">
                        <div class="text-slate-500 italic text-sm">No parties yet. Start by planning one!</div>
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6 space-y-4">
                    <button id="btnContacts" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2">
                            <path d="M14 19a6 6 0 0 0-12 0"/>
                            <circle cx="8" cy="9" r="4"/>
                            <path d="M22 19a6 6 0 0 0-6-6h-2"/>
                            <circle cx="16" cy="9" r="4"/>
                        </svg>
                        Manage Contacts
                    </button>
                    <button id="toggleCalendar" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar">
                            <path d="M8 2v4"/>
                            <path d="M16 2v4"/>
                            <rect width="18" height="18" x="3" y="4" rx="2"/>
                            <path d="M3 10h18"/>
                        </svg>
                        Show Calendar
                    </button>
                    <div class="flex items-center gap-2">
                        <button id="btnExport" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm flex-1">Export</button>
                        <label class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm flex-1 cursor-pointer">
                            Import
                            <input id="importFile" type="file" accept="application/json" class="hidden"/>
                        </label>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnSeed" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm flex-1">Load Sample</button>
                        <button id="btnReset" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md flex-1">Reset All</button>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarBlock" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <button id="calPrev" class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left">
                                <path d="m15 18-6-6 6-6"/>
                            </svg>
                        </button>
                        <div id="calTitle" class="text-xl font-semibold"></div>
                        <button id="calNext" class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right">
                                <path d="m9 18 6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                    <div id="calGrid" class="grid grid-cols-7 gap-2 text-center text-sm"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- CONTACTS MODAL -->
    <div id="contactsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 class="text-xl font-semibold">Contacts</h3>
                <div class="flex items-center gap-2">
                    <button id="btnHouseholds" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm">Households</button>
                    <button id="btnAddContact" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm">Add Contact</button>
                    <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#contactsModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto hide-scrollbar max-h-[80vh]">
                <div class="text-sm text-slate-500 mb-4"><span id="contactCount">0</span> total contacts</div>
                <div id="contactList" class="space-y-4"></div>
            </div>
        </div>
    </div>
    
    <!-- ADD/EDIT CONTACT MODAL -->
    <div id="contactFormModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 id="contactFormTitle" class="text-xl font-semibold">Add Contact</h3>
                <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#contactFormModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <form id="contactForm" class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="cId"/>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Name</label><input id="cName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Full name"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Birthday (optional)</label><input id="cBirthday" type="date" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Phone (optional)</label><input id="cPhone" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="555-123-4567"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Email (optional)</label><input id="cEmail" type="email" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="name@email.com"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Household</label><select id="cHousehold" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">...or new household</label><input id="cHouseholdNew" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="The Johnsons"/></div>
                <div class="flex gap-2 items-end mt-4 sm:col-span-2">
                    <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="submit">Save Contact</button>
                    <button type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" id="cClear">Clear</button>
                </div>
            </form>
            <div class="p-4 text-xs italic text-slate-500">
                You can find your `userId` here: <span id="userIdDisplay" class="font-mono"></span>
            </div>
        </div>
    </div>
    
    <!-- HOUSEHOLDS MODAL -->
    <div id="householdsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 class="text-xl font-semibold">Households</h3>
                <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#householdsModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <form id="houseForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div><label class="block text-sm font-medium text-slate-600 mb-1">Household Name</label><input id="hName" placeholder="Garcia Family" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                    <div class="flex gap-2 items-end">
                        <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="submit">Add Household</button>
                        <button type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" id="hClear">Clear</button>
                    </div>
                </form>
                <div class="overflow-x-auto hide-scrollbar">
                    <table class="w-full table-auto text-sm">
                        <thead>
                            <tr class="text-left text-slate-500 font-medium">
                                <th class="p-2">Household</th>
                                <th class="p-2">Members</th>
                                <th class="p-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="houseTableBody" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CREATE PARTY (PLAN) MODAL -->
    <div id="createPlanModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 class="text-xl font-semibold">Plan a Party</h3>
                <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#createPlanModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <form id="partyPlanForm" class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="pId"/>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Party Name</label><input id="pTitle" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Alex’s 30th Bash"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Date</label><input id="pDate" type="date" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Time (optional)</label><input id="pTime" type="time" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">For (optional)</label><select id="pFor" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select></div>
                <div class="flex gap-2 items-end mt-4 sm:col-span-2">
                    <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="submit">Create Party</button>
                    <button type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" data-close="#createPlanModal">Cancel</button>
                </div>
            </form>
            <div class="text-sm text-slate-500 p-6 pt-0">
                Need a new contact? <button class="text-blue-600 hover:text-blue-800 underline transition-colors" id="quickAddFromPlanner">Add one here</button>
            </div>
        </div>
    </div>
    
    <!-- CREATE PARTY (ATTEND) MODAL -->
    <div id="createAttendModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 class="text-xl font-semibold">Attend a Party</h3>
                <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#createAttendModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <form id="partyAttendForm" class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input type="hidden" id="aId"/>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Party Name</label><input id="aTitle" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Taylor’s BBQ"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Date</label><input id="aDate" type="date" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Time (optional)</label><input id="aTime" type="time" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">For (optional)</label><select id="aFor" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select></div>
                <div><label class="block text-sm font-medium text-slate-600 mb-1">Gift I plan to bring</label><input id="aGiftPlan" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Wine, game…"/></div>
                <div class="sm:col-span-2"><label class="block text-sm font-medium text-slate-600 mb-1">Notes (what to bring / reminders)</label><textarea id="aNotes" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Snacks? Cooler? Ride?"></textarea></div>
                <div class="flex gap-2 items-end mt-4 sm:col-span-2">
                    <button id="btnSaveAttend" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="button">Save</button>
                    <button type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" data-close="#createAttendModal">Cancel</button>
                </div>
            </form>
            <div class="text-sm text-slate-500 p-6 pt-0">
                Need a new contact? <button class="text-blue-600 hover:text-blue-800 underline transition-colors" id="quickAddFromAttendee">Add one here</button>
            </div>
        </div>
    </div>
    
    <!-- PARTY DETAILS MODAL -->
    <div id="partyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900 bg-opacity-30 backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh]">
            <div class="flex justify-between items-center p-4 -mx-4 -mt-4 sm:p-6 sm:-mx-6 sm:-mt-6 mb-4 border-b border-slate-200">
                <h3 id="dTitle" class="text-xl font-semibold truncate">Party</h3>
                <div class="flex items-center gap-2">
                    <button id="btnPrintChecklist" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm hidden print:inline-flex">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer">
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <path d="M6 14v4a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-4"/>
                            <path d="M18 8a2 2 0 0 1-2-2v-2a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2a2 2 0 0 1-2 2"/>
                            <path d="M12 18v6"/>
                            <path d="M12 2v-4"/>
                        </svg>
                        Print
                    </button>
                    <button id="btnDeleteParty" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"/>
                            <path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"/>
                            <line x1="10" x2="10" y1="11" y2="17"/>
                            <line x1="14" x2="14" y1="11" y2="17"/>
                        </svg>
                        Delete
                    </button>
                    <button class="p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors" data-close="#partyModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto hide-scrollbar max-h-[90vh] space-y-6">
                <!-- Party Details -->
                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                    <span id="dRole" class="inline-flex items-center gap-1 text-xs font-medium bg-blue-100 text-blue-600 rounded-full px-2 py-0.5">PLANNING</span>
                    <span id="dDate" class="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full px-2 py-0.5">—</span>
                    <span id="dTime" class="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full px-2 py-0.5">Time: —</span>
                    <span id="dFor" class="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full px-2 py-0.5">For: —</span>
                    <span id="dDays" class="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-green-700 rounded-full px-2 py-0.5">—</span>
                </div>

                <!-- HOST VIEW -->
                <div id="hostBlocks" class="space-y-6">
                    <!-- Summary -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                        <div class="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Estimated Cost<div class="text-lg font-bold" id="summaryCost">$0.00</div></div>
                        <div class="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Items To Buy<div class="text-lg font-bold" id="summaryItems">0</div></div>
                        <div class="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Guests Confirmed<div class="text-lg font-bold" id="summaryConfirmed">0</div></div>
                        <div class="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Adults<div class="text-lg font-bold" id="cntAdults">0</div></div>
                        <div class="bg-slate-100 rounded-lg p-3 text-center text-sm font-medium text-slate-600 shadow-sm">Kids<div class="text-lg font-bold" id="cntKids">0</div></div>
                    </div>

                    <!-- Local Weather -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <div class="flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                            <h4 class="text-lg font-semibold text-slate-700">Local Weather Forecast</h4>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down text-slate-500">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div id="weatherContent" class="mt-2 text-sm text-slate-600">
                            <p>Click below to load the weather forecast.</p>
                            <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md mt-2" id="btnLoadWeather">Load Weather</button>
                        </div>
                    </div>

                    <!-- Sections -->
                    <div class="bg-white rounded-xl shadow-md p-4 space-y-4">
                        <h4 class="text-lg font-semibold text-slate-700">Guests & Invitees</h4>
                        <div class="flex flex-wrap gap-2 text-sm">
                            <div class="text-slate-500">Expected Guests:</div>
                            <input id="guestCount" type="number" min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all w-24 h-8 text-center" />
                        </div>
                        <form id="inviteePicker" class="flex flex-wrap items-end gap-2">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-sm font-medium text-slate-600 mb-1">Pick a contact</label>
                                <select id="invContact" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                            </div>
                            <button id="btnAddInvitee" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="button">Add</button>
                            <button id="btnOpenContactModal" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm" type="button">New Contact</button>
                        </form>
                        <div class="overflow-x-auto hide-scrollbar">
                            <table class="w-full table-auto text-sm">
                                <thead>
                                    <tr class="text-left text-slate-500 font-medium">
                                        <th class="p-2">Name</th>
                                        <th class="p-2">Age</th>
                                        <th class="p-2">Status</th>
                                        <th class="p-2">Gift</th>
                                        <th class="p-2">Thank You</th>
                                        <th class="p-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inviteeTableBody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-4 space-y-4">
                        <h4 class="text-lg font-semibold text-slate-700">Shopping List & Assignments</h4>
                        <form id="itemForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Item</label><input id="itName" placeholder="Cake, plates…" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Qty</label><input id="itQty" type="number" min="1" value="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Cost (each)</label><input id="itCost" type="number" min="0" step="0.01" value="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Assign to</label><select id="itAssign" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="itStatus" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"><option value="todo">To buy</option><option value="ordered">Ordered</option><option value="picked">Picked up</option></select></div>
                            <div class="flex gap-2">
                                <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md flex-1" type="submit">Add Item</button>
                                <button type="button" id="btnClearItem" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm flex-1">Clear</button>
                            </div>
                        </form>
                        <div class="overflow-x-auto hide-scrollbar">
                            <table class="w-full table-auto text-sm">
                                <thead>
                                    <tr class="text-left text-slate-500 font-medium">
                                        <th class="p-2">Item</th>
                                        <th class="p-2">Assigned</th>
                                        <th class="p-2">Qty</th>
                                        <th class="p-2">Cost</th>
                                        <th class="p-2">Status</th>
                                        <th class="p-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="itemTableBody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Vendors Section -->
                    <div class="bg-white rounded-xl shadow-md p-4 space-y-4">
                        <h4 class="text-lg font-semibold text-slate-700">Vendors</h4>
                        <form id="vendorForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Name</label><input id="vName" placeholder="Sweet Tooth Cakes" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Type</label><input id="vType" placeholder="Bakery / Venue / DJ" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Phone</label><input id="vPhone" placeholder="555-987-6543" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Email</label><input id="vEmail" type="email" placeholder="hello@vendor.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Website</label><input id="vSite" placeholder="https://…" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Notes</label><input id="vNotes" placeholder="Pickup at 3pm" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"/></div>
                            <div class="flex gap-2">
                                <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md flex-1" type="submit">Add Vendor</button>
                                <button type="button" id="btnClearVendor" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm flex-1">Clear</button>
                            </div>
                        </form>
                        <div class="overflow-x-auto hide-scrollbar">
                            <table class="w-full table-auto text-sm">
                                <thead>
                                    <tr class="text-left text-slate-500 font-medium">
                                        <th class="p-2">Vendor</th>
                                        <th class="p-2">Type</th>
                                        <th class="p-2">Contact</th>
                                        <th class="p-2">Notes</th>
                                        <th class="p-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vendorTableBody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Invitation Section -->
                    <div class="bg-white rounded-xl shadow-md p-4 space-y-4">
                        <h4 class="text-lg font-semibold text-slate-700">Invitation</h4>
                        <div class="flex flex-wrap items-center gap-2 text-sm text-slate-500">
                            <input id="invFile" type="file" accept="image/*,application/pdf" class="hidden"/>
                            <label for="invFile" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
                                </svg>
                                Upload
                            </label>
                            <span class="flex-1 text-sm text-slate-500 truncate" id="invMeta">No invitation uploaded yet.</span>
                            <button id="btnInvDownload" type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm hidden">Download</button>
                            <button id="btnInvRemove" type="button" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md hidden">Remove</button>
                        </div>
                        <div id="invPreviewWrap" class="hidden mt-2">
                            <div id="invPreview" class="border border-slate-200 rounded-lg p-2 bg-slate-100 flex justify-center items-center"></div>
                        </div>
                    </div>
                </div>

                <!-- ATTEND VIEW -->
                <div id="attendBlocks" class="hidden space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-4 space-y-4">
                        <h4 class="text-lg font-semibold text-slate-700">Attending Details</h4>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Gift I plan to bring</label>
                            <input id="aGiftPlanEdit" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Gift idea…"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Notes (what to bring / reminders)</label>
                            <textarea id="aNotesEdit" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Snacks? Cooler? Ride?"></textarea>
                        </div>
                        <button id="btnSaveAttendModal" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-white bg-slate-800 hover:bg-slate-900 transition-colors shadow-md" type="button">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Message box container -->
    <div id="messageBoxContainer" class="fixed top-4 right-4 z-[60] space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Firebase Globals
            let db, auth, userId;
            const appId = "party-planner-1bb4a";
            const firebaseConfig = {
              apiKey: "AIzaSyDPJ2rn4hNLIx7TngFiqpfAnB7VH0p2NbI",
              authDomain: "party-planner-1bb4a.firebaseapp.com",
              projectId: "party-planner-1bb4a",
              storageBucket: "party-planner-1bb4a.firebasestorage.app",
              messagingSenderId: "509771206054",
              appId: "1:509771206054:web:c92c7f6aef1cb07b33d367"
            };
            const initialAuthToken = null;

            // Message Box Function
            function showMessage(message, type = 'info') {
                const container = document.getElementById('messageBoxContainer');
                const messageEl = document.createElement('div');
                messageEl.className = `p-4 rounded-lg shadow-lg text-sm font-medium text-white transition-all duration-300 transform opacity-0 translate-x-full`;
                
                let bgColor = 'bg-blue-500';
                if (type === 'success') bgColor = 'bg-green-500';
                if (type === 'error') bgColor = 'bg-red-500';
                
                messageEl.classList.add(bgColor);
                messageEl.textContent = message;
                
                container.appendChild(messageEl);

                setTimeout(() => {
                    messageEl.classList.remove('opacity-0', 'translate-x-full');
                    messageEl.classList.add('opacity-100', 'translate-x-0');
                }, 10);
                
                setTimeout(() => {
                    messageEl.classList.remove('opacity-100', 'translate-x-0');
                    messageEl.classList.add('opacity-0', 'translate-x-full');
                    messageEl.addEventListener('transitionend', () => messageEl.remove());
                }, 3000);
            }

            /* ===== Utils & Storage ===== */
            const $ = s => document.querySelector(s);
            const $$ = s => Array.from(document.querySelectorAll(s));
            const uid = () => Math.random().toString(36).slice(2, 10);
            const fmtMoney = n => `$${(Number(n) || 0).toFixed(2)}`;
            const parseISO = s => s ? new Date(s + 'T12:00:00') : null;
            const todayISO = () => new Date().toISOString().slice(0, 10);
            function hashHue(str) { let h = 0; for (let i = 0; i < str.length; i++) { h = (h * 31 + str.charCodeAt(i)) >>> 0; } return h % 360; }
            function colorForContact(idOrName) { const key = idOrName || ''; const hue = hashHue(key); return `hsl(${hue} 70% 45%)`; }
            
            const Data = {
                save: async (collectionName, data) => {
                    if (!db || !userId) {
                        showMessage("App not ready. Please try again.", "error");
                        return [];
                    }
                    const userRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                    try {
                        const savedDocs = [];
                        for (const item of data) {
                            if (item.docId) {
                                const itemWithoutDocId = { ...item };
                                delete itemWithoutDocId.docId;
                                await firebase.setDoc(firebase.doc(userRef, item.docId), itemWithoutDocId);
                                savedDocs.push({ ...item });
                            } else {
                                const newDocRef = await firebase.addDoc(userRef, item);
                                savedDocs.push({ ...item, docId: newDocRef.id });
                            }
                        }
                        return savedDocs;
                    } catch (e) {
                        console.error("Error saving data: ", e);
                        showMessage("Error saving data.", "error");
                        return [];
                    }
                },
                get: async (collectionName) => {
                    if (!db || !userId) {
                        showMessage("App not ready. Please try again.", "error");
                        return [];
                    }
                    const userRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                    try {
                        const q = firebase.query(userRef);
                        const querySnapshot = await firebase.getDocs(q);
                        const data = [];
                        querySnapshot.forEach((doc) => {
                            data.push({ ...doc.data(), docId: doc.id });
                        });
                        return data;
                    } catch (e) {
                        console.error("Error getting data: ", e);
                        showMessage("Error fetching data.", "error");
                        return [];
                    }
                },
                delete: async (collectionName, docId) => {
                    if (!db || !userId) {
                        showMessage("App not ready. Please try again.", "error");
                        return false;
                    }
                    const userRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                    try {
                        await firebase.deleteDoc(firebase.doc(userRef, docId));
                        return true;
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        showMessage("Error deleting document.", "error");
                        return false;
                    }
                }
            };
            
            let state = { contacts: [], households: [], parties: [] };
            let currentParty = null;

            // Firebase Initialization & Auth
            function initFirebase() {
                try {
                    const app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.getAuth(app);
                    db = firebase.getFirestore(app);

                    firebase.onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            // Display userId in the modal for debug/collaboration
                            const userIdEl = $('#userIdDisplay');
                            if (userIdEl) {
                                userIdEl.textContent = userId;
                            }
                            await loadInitialData();
                            setupRealtimeListeners();
                        } else {
                            if (initialAuthToken) {
                                await firebase.signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await firebase.signInAnonymously(auth);
                            }
                        }
                    });
                } catch (e) {
                    console.error("Firebase init error: ", e);
                    showMessage("Failed to initialize Firebase. Please check your console.", "error");
                }
            }

            async function loadInitialData() {
                // Ensure Firebase is initialized and user is authenticated before calling Data.get
                if (!db || !userId) {
                    // It is possible this is called before onAuthStateChanged completes.
                    // Instead of failing, we will let the listeners handle it.
                    return;
                }
                state.contacts = await Data.get('contacts');
                state.households = await Data.get('households');
                state.parties = await Data.get('parties');
                renderParties();
                renderCalendar();
                // Load sample data if the user's account is empty
                if (state.parties.length === 0) {
                    await loadSampleData();
                }
            }
            
            function setupRealtimeListeners() {
                // Ensure Firebase is initialized and user is authenticated before setting up listeners
                if (!db || !userId) return;

                const contactsRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/contacts`);
                const partiesRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/parties`);
                const householdsRef = firebase.collection(db, `artifacts/${appId}/users/${userId}/households`);

                firebase.onSnapshot(contactsRef, (snapshot) => {
                    state.contacts = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
                    renderContacts();
                    renderHouseholdSelects();
                    if (currentParty) {
                        renderInvitees();
                        renderItems();
                        updateCountsAndLists();
                    }
                });
                firebase.onSnapshot(partiesRef, (snapshot) => {
                    state.parties = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
                    renderParties();
                    renderCalendar();
                });
                firebase.onSnapshot(householdsRef, (snapshot) => {
                    state.households = snapshot.docs.map(d => ({ docId: d.id, ...d.data() }));
                    renderHouseholds();
                    renderHouseholdSelects();
                    if (currentParty) renderContacts();
                });
            }

            /* ===== Date helpers ===== */
            function safeDateParts(iso) {
                if (!iso) return null;
                const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
                if (!m) return null;
                const y = +m[1], mo = +m[2], d = +m[3];
                if (mo < 1 || mo > 12 || d < 1 || d > 31) return null;
                return { y, mo, d };
            }

            function ageOnDate(birthISO, refISO) {
                const b = safeDateParts(birthISO), r = safeDateParts(refISO);
                if (!b || !r) return null;
                let a = r.y - b.y;
                const had = (r.mo > b.mo) || (r.mo === b.mo && r.d >= b.d);
                if (!had) a--;
                return a;
            }

            function daysUntil(iso) {
                const d = parseISO(iso);
                if (!d) return null;
                const today = new Date();
                const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const tgt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                return Math.round((tgt - base) / 86400000);
            }

            /* ===== Modals ===== */
            function openModal(sel) {
                const m = $(sel);
                if (m) {
                    m.classList.remove('hidden');
                    setTimeout(() => m.classList.add('show'), 10);
                }
            }

            function closeModal(sel) {
                const m = $(sel);
                if (m) {
                    m.classList.remove('show');
                    setTimeout(() => m.classList.add('hidden'), 300);
                }
            }

            document.body.addEventListener('click', e => {
                const b = e.target.closest('[data-close]');
                if (b) closeModal(b.getAttribute('data-close'));
            });

            $$('.modal-bg').forEach(m => m.addEventListener('click', e => {
                if (e.target === m) closeModal('#' + m.id);
            }));

            /* ===== Contacts & Households ===== */
            function householdName(id) {
                return state.households.find(h => h.docId === id)?.name || '—';
            }

            function renderHouseholdSelects() {
                const opts = ['<option value="">— None —</option>'].concat(state.households.map(h => `<option value="${h.docId}">${h.name}</option>`)).join('');
                $('#cHousehold').innerHTML = opts;
                $('#pFor').innerHTML = ['<option value="">— Optional —</option>'].concat(state.contacts.map(c => `<option value="${c.docId}">${c.name}</option>`)).join('');
                $('#aFor').innerHTML = $('#pFor').innerHTML;
                $('#invContact').innerHTML = ['<option value="">— Select —</option>'].concat(state.contacts.map(c => `<option value="${c.docId}">${c.name}</option>`)).join('');
                $('#itAssign').innerHTML = ['<option value="">— Unassigned —</option>'].concat(state.contacts.map(c => `<option value="${c.docId}">${c.name}</option>`)).join('');
            }

            function renderContacts() {
                const wrap = $('#contactList');
                wrap.innerHTML = '';
                const contacts = state.contacts.slice().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                $('#contactCount').textContent = contacts.length;
                contacts.forEach(c => {
                    const age = c.birthday ? ageOnDate(c.birthday, todayISO()) : null;
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-bold text-lg">${c.name}</div>
                            <div class="flex gap-2">
                                <button class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm text-sm" data-edit="${c.docId}">Edit</button>
                                <button class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md text-sm" data-del="${c.docId}">Delete</button>
                            </div>
                        </div>
                        <div class="text-sm text-slate-500 space-y-1">
                            <div>Household: <span class="text-slate-700">${householdName(c.householdId)}</span></div>
                            <div>Birthday: <span class="text-slate-700">${c.birthday || '—'}</span></div>
                            <div>Age: <span class="text-slate-700">${age !== null ? age : '—'}</span></div>
                        </div>
                    `;
                    wrap.appendChild(card);
                });
                wrap.onclick = async e => {
                    const del = e.target.closest('button[data-del]');
                    const edit = e.target.closest('button[data-edit]');
                    if (del) {
                        const id = del.dataset.del;
                        if (!confirm('Delete this contact?')) return;
                        await Data.delete('contacts', id);
                    }
                    if (edit) {
                        const id = edit.dataset.edit;
                        const c = state.contacts.find(x => x.docId === id);
                        if (!c) return;
                        $('#contactFormTitle').textContent = 'Edit Contact';
                        $('#cId').value = c.docId;
                        $('#cName').value = c.name;
                        $('#cBirthday').value = c.birthday || '';
                        $('#cPhone').value = c.phone || '';
                        $('#cEmail').value = c.email || '';
                        $('#cHousehold').value = c.householdId || '';
                        $('#cHouseholdNew').value = '';
                        openModal('#contactFormModal');
                    }
                };
                renderHouseholdSelects();
            }

            function renderHouseholds() {
                const tbody = $('#houseTableBody');
                tbody.innerHTML = '';
                state.households.forEach(h => {
                    const members = state.contacts.filter(c => c.householdId === h.docId).map(c => c.name).join(', ') || '—';
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';
                    tr.innerHTML = `
                        <td class="p-2">${h.name}</td>
                        <td class="p-2 text-slate-500 text-xs">${members}</td>
                        <td class="p-2 text-right"><button class="flex items-center justify-center gap-2 px-2 py-0.5 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md text-xs" data-hdel="${h.docId}">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            $('#houseTableBody').addEventListener('click', async e => {
                const del = e.target.closest('button[data-hdel]');
                if (!del) return;
                const id = del.dataset.hdel;
                const used = state.contacts.some(c => c.householdId === id);
                if (used) {
                    showMessage('Remove members from this household first.', 'error');
                    return;
                }
                await Data.delete('households', id);
            });

            $('#houseForm').addEventListener('submit', async e => {
                e.preventDefault();
                const name = $('#hName').value.trim();
                if (!name) {
                    showMessage('Household name required.', 'error');
                    return;
                }
                const newHousehold = { name };
                await Data.save('households', [newHousehold]);
                $('#hName').value = '';
                showMessage('Household added successfully.', 'success');
            });

            $('#hClear').addEventListener('click', () => {
                $('#hName').value = '';
            });

            $('#contactForm').addEventListener('submit', async e => {
                e.preventDefault();
                let householdId = $('#cHousehold').value || null;
                const newHouseName = $('#cHouseholdNew').value.trim();
                if (newHouseName) {
                    let exists = state.households.find(h => h.name.toLowerCase() === newHouseName.toLowerCase());
                    if (exists) {
                        householdId = exists.docId;
                    } else {
                        const newHousehold = { name: newHouseName };
                        const savedHousehold = (await Data.save('households', [newHousehold]))[0];
                        householdId = savedHousehold.docId;
                    }
                }
                const existingId = $('#cId').value;
                const contactData = {
                    name: $('#cName').value.trim(),
                    birthday: $('#cBirthday').value || null,
                    phone: $('#cPhone').value.trim(),
                    email: $('#cEmail').value.trim(),
                    householdId
                };
                if (!contactData.name) {
                    showMessage('Name is required.', 'error');
                    return;
                }
                if (existingId) {
                    contactData.docId = existingId;
                    await Data.save('contacts', [contactData]);
                    showMessage('Contact updated successfully.', 'success');
                } else {
                    await Data.save('contacts', [contactData]);
                    showMessage('Contact added successfully.', 'success');
                }
                $('#contactForm').reset();
                $('#cId').value = '';
                $('#contactFormTitle').textContent = 'Add Contact';
                closeModal('#contactFormModal');
            });

            $('#cClear').addEventListener('click', () => {
                $('#contactForm').reset();
                $('#cId').value = '';
                $('#contactFormTitle').textContent = 'Add Contact';
            });

            /* ===== Parties ===== */
            function personName(id) {
                return id ? (state.contacts.find(c => c.docId === id)?.name || '—') : '—';
            }

            function personColor(id) {
                return id ? colorForContact(id) : '#94a3b8';
            }

            const partyListEl = $('#partyList');
            function renderParties() {
                partyListEl.innerHTML = '';
                const parties = state.parties.slice().sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                $('#partyCount').textContent = `${parties.length} Parties`;
                if (parties.length === 0) {
                    partyListEl.innerHTML = '<div class="text-slate-500 italic text-sm">No parties yet. Start by planning one!</div>';
                    return;
                }
                parties.forEach(p => {
                    const name = p.forContactId ? personName(p.forContactId) : '—';
                    const hue = personColor(p.forContactId || name);
                    const dLeft = daysUntil(p.date);
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-lg shadow-sm p-4 border-l-4 transition-all duration-200 hover:shadow-md cursor-pointer';
                    el.style.borderColor = hue;
                    el.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <div class="font-semibold text-slate-800 truncate">${p.title}</div>
                            <span class="inline-flex items-center gap-1 text-xs font-medium bg-slate-100 text-slate-600 rounded-full px-2 py-0.5">${p.role === 'host' ? 'Host' : 'Attending'}</span>
                        </div>
                        <div class="text-sm text-slate-500">
                            ${p.date || '—'}
                            ${dLeft !== null ? (dLeft === 0 ? '<span class="text-green-600 font-medium">🎉 Today</span>' : dLeft > 0 ? `in ${dLeft} day${dLeft === 1 ? '' : 's'}` : `${Math.abs(dLeft)} day${Math.abs(dLeft) === 1 ? '' : 's'} ago`) : '—'}
                        </div>
                        <div class="text-sm text-slate-500">
                            For: <span class="text-slate-700 font-medium">${name}</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm text-xs" data-open="${p.docId}">Open</button>
                            <button class="flex items-center justify-center gap-2 px-3 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md text-xs" data-delete="${p.docId}">Delete</button>
                        </div>
                    `;
                    partyListEl.appendChild(el);
                });
            }

            partyListEl.onclick = async (e) => {
                const openBtn = e.target.closest('button[data-open]');
                const delBtn = e.target.closest('button[data-delete]');
                if (openBtn) {
                    openParty(openBtn.getAttribute('data-open'));
                }
                if (delBtn) {
                    const id = delBtn.getAttribute('data-delete');
                    if (confirm('Delete this party?')) {
                        await Data.delete('parties', id);
                    }
                }
            };

            $('#btnPlan').onclick = () => openModal('#createPlanModal');
            $('#btnAttend').onclick = () => openModal('#createAttendModal');

            $('#partyPlanForm').addEventListener('submit', async e => {
                e.preventDefault();
                const p = {
                    title: $('#pTitle').value.trim(),
                    date: $('#pDate').value || null,
                    time: $('#pTime').value || null,
                    role: 'host',
                    forContactId: $('#pFor').value || null,
                    invitees: [],
                    items: [],
                    vendors: [],
                    attend: { giftPlan: '', notes: '' },
                    invitation: null,
                    guestCount: 0
                };
                if (!p.title || !p.date) {
                    showMessage('Party name and date are required.', 'error');
                    return;
                }
                await Data.save('parties', [p]);
                closeModal('#createPlanModal');
                showMessage('Party planned successfully!', 'success');
            });

            $('#partyAttendForm').addEventListener('submit', async e => {
                e.preventDefault();
                const p = {
                    title: $('#aTitle').value.trim(),
                    date: $('#aDate').value || null,
                    time: $('#aTime').value || null,
                    role: 'attend',
                    forContactId: $('#aFor').value || null,
                    attend: { giftPlan: $('#aGiftPlan').value.trim(), notes: $('#aNotes').value.trim() },
                };
                if (!p.title || !p.date) {
                    showMessage('Party name and date are required.', 'error');
                    return;
                }
                await Data.save('parties', [p]);
                closeModal('#createAttendModal');
                showMessage('Party added successfully!', 'success');
            });

            $('#quickAddFromPlanner').onclick = () => openModal('#contactFormModal');
            $('#quickAddFromAttendee').onclick = () => openModal('#contactFormModal');

            /* ===== Party Modal / Counts ===== */
            function calcAgeBucket(contactId, partyDateISO) {
                const birth = state.contacts.find(c => c.docId === contactId)?.birthday || null;
                if (!birth) return { bucket: 'unknown', age: null };
                const a = ageOnDate(birth, partyDateISO);
                if (a == null) return { bucket: 'unknown', age: null };
                return a < 18 ? { bucket: 'kid', age: a } : { bucket: 'adult', age: a };
            }

            function updateCountsAndLists() {
                if (!currentParty) return;
                const confirmed = (currentParty.invitees || []).filter(i => i.status === 'confirmed');
                const itemsToBuy = (currentParty.items || []).filter(i => i.status !== 'picked').length;
                const estimatedCost = (currentParty.items || []).reduce((s, it) => s + (Number(it.cost) || 0) * (Number(it.qty) || 1), 0);

                $('#summaryCost').textContent = fmtMoney(estimatedCost);
                $('#summaryItems').textContent = itemsToBuy;
                $('#summaryConfirmed').textContent = confirmed.length;

                const confirmedKids = confirmed.filter(i => calcAgeBucket(i.contactId, currentParty.date).bucket === 'kid').length;
                const confirmedAdults = confirmed.filter(i => calcAgeBucket(i.contactId, currentParty.date).bucket === 'adult').length;

                $('#cntKids').textContent = confirmedKids;
                $('#cntAdults').textContent = confirmedAdults;
            }

            async function openParty(id) {
                currentParty = state.parties.find(p => p.docId === id);
                if (!currentParty) return;
                $('#dTitle').textContent = currentParty.title;
                $('#dRole').textContent = currentParty.role === 'host' ? 'HOST' : 'ATTENDING';
                $('#dDate').textContent = currentParty.date || '—';
                $('#dTime').textContent = currentParty.time ? `Time: ${currentParty.time}` : 'Time: —';
                $('#dFor').textContent = currentParty.forContactId ? `For: ${personName(currentParty.forContactId)}` : 'For: —';
                const dLeft = daysUntil(currentParty.date);
                $('#dDays').textContent = dLeft !== null ? (dLeft === 0 ? 'Today 🎉' : dLeft > 0 ? `in ${dLeft} day${dLeft === 1 ? '' : 's'}` : `${Math.abs(dLeft)} day${Math.abs(dLeft) === 1 ? '' : 's'} ago`) : '—';
                
                if (currentParty.role === 'host') {
                    $('#hostBlocks').classList.remove('hidden');
                    $('#attendBlocks').classList.add('hidden');
                } else {
                    $('#hostBlocks').classList.add('hidden');
                    $('#attendBlocks').classList.remove('hidden');
                    $('#aGiftPlanEdit').value = currentParty.attend?.giftPlan || '';
                    $('#aNotesEdit').value = currentParty.attend?.notes || '';
                }
                
                renderContacts();
                renderInvitees();
                renderItems();
                renderVendors();
                renderInvitation();
                openModal('#partyModal');
                updateCountsAndLists();
            }

            $('#btnDeleteParty').onclick = async () => {
                if (!currentParty) return;
                if (confirm('Delete this party?')) {
                    await Data.delete('parties', currentParty.docId);
                    closeModal('#partyModal');
                    currentParty = null;
                }
            };
            
            $('#btnSaveAttendModal').onclick = async () => {
                if (!currentParty) return;
                currentParty.attend = { giftPlan: $('#aGiftPlanEdit').value.trim(), notes: $('#aNotesEdit').value.trim() };
                await Data.save('parties', [currentParty]);
                showMessage('Saved changes successfully.', 'success');
                closeModal('#partyModal');
            };

            /* ===== Invitees (host) ===== */
            function addInviteeByContactId(id) {
                if (!currentParty || currentParty.role !== 'host') return;
                if (!id) {
                    showMessage('Pick a contact first.', 'error');
                    return;
                }
                if ((currentParty.invitees || []).some(i => i.contactId === id)) {
                    showMessage('Already invited.', 'error');
                    return;
                }
                currentParty.invitees.push({ contactId: id, status: 'invited', gift: '', thankYou: false });
                Data.save('parties', [currentParty]);
            }

            $('#btnAddInvitee').onclick = () => addInviteeByContactId($('#invContact').value);
            $('#btnOpenContactModal').onclick = () => {
                closeModal('#partyModal');
                openModal('#contactFormModal');
            };

            function renderInvitees() {
                if (!currentParty || currentParty.role !== 'host') return;
                const tbody = $('#inviteeTableBody');
                tbody.innerHTML = '';
                (currentParty.invitees || []).forEach((i, idx) => {
                    const c = state.contacts.find(c => c.docId === i.contactId);
                    const age = c?.birthday ? ageOnDate(c.birthday, currentParty.date) : null;
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';
                    tr.innerHTML = `
                        <td class="p-2">${c ? c.name : '(Unknown)'}</td>
                        <td class="p-2">${age == null ? '—' : age}</td>
                        <td class="p-2">
                            <span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-2 py-0.5 ${i.status === 'confirmed' ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-600'}">
                                ${i.status === 'confirmed' ? 'Confirmed' : 'Invited'}
                            </span>
                        </td>
                        <td class="p-2">
                            <input type="text" data-type="gift" data-idx="${idx}" value="${i.gift || ''}" placeholder="Gift…" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-xs h-8"/>
                        </td>
                        <td class="p-2 text-center">
                            <input type="checkbox" data-type="thanks" data-idx="${idx}" ${i.thankYou ? 'checked' : ''} class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-slate-300"/>
                        </td>
                        <td class="p-2 text-right flex gap-1 justify-end">
                            <button data-act="toggle" data-idx="${idx}" class="flex items-center justify-center gap-2 px-2 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm text-xs">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check">
                                    <path d="M20 6 9 17l-5-5"/>
                                </svg>
                            </button>
                            <button data-act="remove" data-idx="${idx}" class="flex items-center justify-center gap-2 px-2 py-1 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md text-xs">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"/><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                tbody.oninput = (e) => { const t = e.target; const idx = +t.dataset.idx; if (t.dataset.type === 'gift') { currentParty.invitees[idx].gift = t.value; Data.save('parties', [currentParty]); } };
                tbody.onchange = (e) => { const t = e.target; const idx = +t.dataset.idx; if (t.dataset.type === 'thanks') { currentParty.invitees[idx].thankYou = t.checked; Data.save('parties', [currentParty]); } };
                $('#guestCount').value = currentParty.guestCount || (currentParty.invitees?.length || 0);
                updateCountsAndLists();
            }

            $('#inviteeTableBody').addEventListener('click', e => {
                if (!currentParty || currentParty.role !== 'host') return;
                const b = e.target.closest('button'); if (!b) return;
                const idx = +b.dataset.idx;
                if (b.dataset.act === 'remove') {
                    currentParty.invitees.splice(idx, 1);
                }
                if (b.dataset.act === 'toggle') {
                    currentParty.invitees[idx].status = currentParty.invitees[idx].status === 'confirmed' ? 'invited' : 'confirmed';
                }
                Data.save('parties', [currentParty]);
            });

            $('#guestCount').addEventListener('input', e => {
                if (!currentParty) return;
                currentParty.guestCount = Number(e.target.value) || 0;
                Data.save('parties', [currentParty]);
            });

            /* ===== Items (host) ===== */
            function statusBadge(s) {
                const colors = {
                    'picked': 'bg-green-100 text-green-600',
                    'ordered': 'bg-blue-100 text-blue-600',
                    'todo': 'bg-slate-100 text-slate-600'
                };
                return `<span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-2 py-0.5 ${colors[s]}">${s.toUpperCase().replace('-', ' ')}</span>`;
            }

            function findContactNameById(id) {
                return state.contacts.find(c => c.docId === id)?.name;
            }

            function renderItems() {
                if (!currentParty || currentParty.role !== 'host') return;
                const tbody = $('#itemTableBody');
                tbody.innerHTML = '';
                (currentParty.items || []).forEach((it, idx) => {
                    const assignee = it.assignedTo ? (findContactNameById(it.assignedTo) || '—') : '—';
                    const line = (Number(it.cost) || 0) * (Number(it.qty) || 1);
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';
                    tr.innerHTML = `
                        <td class="p-2">${it.name}</td>
                        <td class="p-2 text-slate-500">${assignee}</td>
                        <td class="p-2">${it.qty || 1}</td>
                        <td class="p-2">${fmtMoney(line)}</td>
                        <td class="p-2">${statusBadge(it.status)}</td>
                        <td class="p-2 text-right flex gap-1 justify-end">
                            <button data-act="status" data-idx="${idx}" class="flex items-center justify-center gap-2 px-2 py-1 rounded-lg font-semibold text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors shadow-sm text-xs">Next</button>
                            <button data-act="remove" data-idx="${idx}" class="flex items-center justify-center gap-2 px-2 py-1 rounded-lg font-semibold text-white bg-r
